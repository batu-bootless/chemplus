<!DOCTYPE html>
<html lang="tr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ChemPlus - Modern Kimya Platformu{% endblock %}</title>
    <meta name="description" content="ChemPlus: Kimya hesaplayıcıları, pH, ideal gaz, molarite ve daha fazlası için modern, hızlı ve doğru araçlar.">
    <meta property="og:title" content="ChemPlus - Modern Kimya Platformu">
    <meta property="og:description" content="Kimya için hesaplama araçları ve akıllı asistan.">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#0ea5e9">
    <link rel="canonical" href="">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="manifest" href="/static/manifest.webmanifest">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        }
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'float-slow': 'float 6s ease-in-out infinite',
                        'float-medium': 'float 4s ease-in-out infinite',
                        'float-fast': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        float: {
                            '0%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-20px)' },
                            '100%': { transform: 'translateY(0px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @media (prefers-reduced-motion: reduce) {
            * { animation: none !important; transition: none !important; }
        }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .glass-dark {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .text-gradient {
            background: linear-gradient(to right, #2563eb, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        @media print {
            nav, #chat-widget, footer, #back-to-top-btn, #shortcuts-modal { display: none !important; }
            main { padding-top: 0 !important; }
            body { background: #fff !important; color: #000 !important; }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex flex-col min-h-screen selection:bg-blue-200 selection:text-blue-900 overflow-x-hidden">
    <a href="#content-start" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-[1000] px-3 py-2 rounded-lg bg-blue-600 text-white">İçeriğe geç</a>

    <nav class="fixed w-full z-50 transition-all duration-300 glass dark:glass-dark" id="navbar">
        <div class="container mx-auto px-6">
            <div class="flex items-center justify-between h-20">
                <a href="{% url 'home' %}" class="flex items-center gap-3 text-2xl font-bold tracking-tight group">
                    <div class="w-10 h-10 bg-gradient-to-tr from-blue-600 to-cyan-500 rounded-xl flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform duration-300">
                        <i class="fa-solid fa-flask"></i>
                    </div>
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-gray-900 to-gray-600 dark:from-gray-100 dark:to-gray-400">ChemPlus</span>
                </a>
                
                <div class="hidden md:flex items-center gap-4">
                    <a href="{% url 'home' %}" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 font-medium transition relative group px-2 py-2">
                        Ana Sayfa
                        <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-blue-600 transition-all group-hover:w-full"></span>
                    </a>
                    <a href="{% url 'calculator_list' %}" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 font-medium transition relative group px-2 py-2">
                        Araçlar
                        <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-blue-600 transition-all group-hover:w-full"></span>
                    </a>
                    <a href="{% url 'forum_home' %}" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 font-medium transition relative group px-2 py-2">
                        Forum
                        <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-blue-600 transition-all group-hover:w-full"></span>
                    </a>
                    <button id="theme-toggle" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Tema">
                        <i class="fa-solid fa-moon hidden dark:block"></i>
                        <i class="fa-solid fa-sun dark:hidden"></i>
                    </button>
                    <button id="copy-url-btn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Bağlantıyı kopyala">
                        <i class="fa-solid fa-link"></i>
                    </button>
                    <button id="install-btn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Uygulamayı yükle" style="display:none">
                        <i class="fa-solid fa-download"></i>
                    </button>
                    <button id="reduce-motion-btn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Animasyonları azalt">
                        <i class="fa-solid fa-wave-square"></i>
                    </button>
                    <button id="shortcuts-btn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Kısayollar">
                        <i class="fa-solid fa-keyboard"></i>
                    </button>
                    <button id="share-page-btn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Sayfayı paylaş">
                        <i class="fa-solid fa-share-nodes"></i>
                    </button>
                    <button id="theme-system-btn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Sistem teması">
                        <i class="fa-solid fa-desktop"></i>
                    </button>
                    <button id="font-reset-btn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Yazı boyutunu sıfırla">
                        <i class="fa-solid fa-text-height"></i>
                    </button>
                    <button id="sw-update-btn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Güncellemeleri kontrol et">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                    <button id="cmd-open-btn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Komut paleti">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                    <span id="online-indicator" class="w-3 h-3 rounded-full bg-green-500 inline-block" title="Durum"></span>
                    <a href="{% url 'login' %}" id="nav-login" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition font-medium">
                        Giriş Yap
                    </a>
                    <a href="{% url 'register' %}" id="nav-register" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition font-medium">
                        Üye Ol
                    </a>
                    <button id="nav-logout" class="hidden px-4 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700 transition font-medium">
                        Çıkış Yap
                    </button>
                </div>

                <button id="mobile-menu-btn" class="md:hidden w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 text-gray-600" aria-label="Menü" aria-expanded="false" aria-controls="mobile-menu">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>
        </div>
    </nav>

    <div id="mobile-menu" class="md:hidden fixed top-20 inset-x-0 z-40 hidden">
        <div class="mx-4 rounded-2xl glass dark:glass-dark border border-white/40 dark:border-white/10 shadow-xl overflow-hidden">
            <div class="p-4 flex flex-col gap-2">
                <a href="{% url 'home' %}" class="px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-800/70 text-gray-700 dark:text-gray-200">Ana Sayfa</a>
                <a href="{% url 'calculator_list' %}" class="px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-800/70 text-gray-700 dark:text-gray-200">Araçlar</a>
                <a href="{% url 'forum_home' %}" class="px-4 py-3 rounded-xl bg-white/70 dark:bg-slate-800/70 text-gray-700 dark:text-gray-200">Forum</a>
                <div class="flex items-center gap-2">
                    <button id="theme-toggle-mobile" class="flex-1 h-11 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200">Tema</button>
                    <button id="clear-cache-btn" class="flex-1 h-11 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200">Önbelleği Temizle</button>
                    <a href="{% url 'login' %}" id="nav-login-mobile" class="flex-1 h-11 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200">Giriş</a>
                    <a href="{% url 'register' %}" id="nav-register-mobile" class="flex-1 h-11 flex items-center justify-center rounded-xl bg-blue-600 text-white">Üye Ol</a>
                    <button id="nav-logout-mobile" class="hidden flex-1 h-11 items-center justify-center rounded-xl bg-red-600 text-white">Çıkış</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[1000] hidden px-4 py-2 rounded-xl bg-gray-900 text-white text-sm shadow-lg" role="status" aria-live="polite"></div>
    <div id="loading-overlay" class="fixed inset-0 z-[1200] hidden bg-black/30 backdrop-blur-sm">
        <div class="absolute inset-0 flex items-center justify-center">
            <div class="w-14 h-14 rounded-full border-4 border-white/50 border-t-white animate-spin"></div>
        </div>
    </div>
    <div id="cmd-modal" class="fixed inset-0 z-[1100] hidden">
        <div class="absolute inset-0 bg-black/50"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-2xl rounded-2xl bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 shadow-2xl border border-gray-100 dark:border-gray-700">
                <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
                    <input id="cmd-input" type="text" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 outline-none" placeholder="Hesaplayıcı ara...">
                    <button id="cmd-close" class="ml-3 w-8 h-8 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-700"><i class="fa-solid fa-times"></i></button>
                </div>
                <div id="cmd-list" class="max-h-[50vh] overflow-y-auto px-6 py-3 space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow pt-20">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-100 mt-auto">
        <div class="container mx-auto px-6 py-12">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="text-center md:text-left">
                    <div class="flex items-center justify-center md:justify-start gap-2 text-xl font-bold text-gray-900 mb-2">
                        <i class="fa-solid fa-flask text-blue-600"></i>
                        <span>ChemPlus</span>
                    </div>
                    <p class="text-gray-500 text-sm">Bilimsel hesaplamalar için modern çözüm ortağınız.</p>
                </div>
                <div class="flex gap-6">
                    <a href="#" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:bg-blue-600 hover:text-white transition-all transform hover:scale-110"><i class="fa-brands fa-twitter"></i></a>
                    <a href="#" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:bg-gray-900 hover:text-white transition-all transform hover:scale-110"><i class="fa-brands fa-github"></i></a>
                    <a href="#" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:bg-pink-600 hover:text-white transition-all transform hover:scale-110"><i class="fa-brands fa-instagram"></i></a>
                </div>
            </div>
            <div class="border-t border-gray-100 mt-8 pt-8 text-center text-gray-400 text-sm">
                &copy; 2024 ChemPlus. Tüm hakları saklıdır.
            </div>
        </div>
    </footer>

    <!-- Chat Widget -->
    <div id="chat-widget" class="fixed bottom-8 right-8 z-50 flex flex-col items-end">
        <!-- Chat Window -->
        <div id="chat-window" class="hidden w-[calc(100vw-2rem)] sm:w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden mb-4 transition-all duration-300 transform origin-bottom-right scale-95 opacity-0">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-cyan-500 p-4 flex items-center justify-between text-white">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-sm">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm">ChemAI Asistan</h3>
                        <p class="text-xs text-blue-100 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> Çevrimiçi</p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-white/80 hover:text-white transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <!-- Messages Area -->
            <div id="chat-messages" class="h-80 overflow-y-auto p-4 bg-gray-50 space-y-3">
                <!-- Welcome Message -->
                <div class="flex items-start gap-2">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs flex-shrink-0">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-sm text-gray-700">
                        Merhaba! Ben ChemAI. Kimya ile ilgili sorularını cevaplamak için buradayım. Sana nasıl yardımcı olabilirim?
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-3 bg-white border-t border-gray-100">
                <form onsubmit="sendMessage(event)" class="relative">
                    <input type="text" id="chat-input" class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-4 pr-10 py-3 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition" placeholder="Bir soru sor..." autocomplete="off">
                    <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center hover:bg-blue-700 transition shadow-sm">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </form>
                <div id="chat-prompts" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- Floating Button -->
        <button onclick="toggleChat()" id="chat-btn" class="w-14 h-14 bg-gradient-to-tr from-blue-600 to-cyan-500 rounded-full shadow-lg shadow-blue-500/30 flex items-center justify-center text-white text-xl hover:scale-110 transition-transform duration-300 animate-bounce hover:animate-none group">
            <i class="fa-solid fa-comments group-hover:hidden"></i>
            <i class="fa-solid fa-chevron-up hidden group-hover:block"></i>
        </button>
    </div>
    <button id="back-to-top-btn" class="fixed bottom-8 left-8 z-50 w-12 h-12 rounded-full bg-gray-800 text-white shadow-lg flex items-center justify-center opacity-0 pointer-events-none transition-all" aria-label="Yukarı çık">
        <i class="fa-solid fa-arrow-up"></i>
    </button>
    <div id="offline-banner" class="fixed top-20 left-0 right-0 z-50 mx-4 md:mx-auto md:max-w-2xl hidden">
        <div class="rounded-xl bg-yellow-100 text-yellow-900 dark:bg-yellow-900 dark:text-yellow-100 px-4 py-3 shadow-lg text-sm flex items-center justify-between">
            <span>Çevrimdışı. Bazı içerikler önbellekten gösteriliyor.</span>
            <div class="flex items-center gap-2">
                <button id="offline-reload" class="px-2 py-1 rounded-lg bg-yellow-200 dark:bg-yellow-800">Yenile</button>
                <button id="offline-dismiss" class="px-2 py-1 rounded-lg bg-yellow-200 dark:bg-yellow-800">Kapat</button>
            </div>
        </div>
    </div>
    <div id="shortcuts-modal" class="fixed inset-0 z-[1000] hidden">
        <div class="absolute inset-0 bg-black/50"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-md rounded-2xl bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 shadow-2xl border border-gray-100 dark:border-gray-700">
                <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
                    <div class="font-bold">Kısayollar</div>
                    <button id="shortcuts-close" class="w-8 h-8 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-700"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="px-6 py-4 space-y-2">
                    <div class="flex items-center justify-between"><span>Tema</span><span class="font-mono">T</span></div>
                    <div class="flex items-center justify-between"><span>Chat</span><span class="font-mono">C</span></div>
                    <div class="flex items-center justify-between"><span>Hesapla</span><span class="font-mono">Enter</span></div>
                    <div class="flex items-center justify-between"><span>Kısayollar</span><span class="font-mono">?</span></div>
                    <div class="flex items-center justify-between"><span>Yukarı Çık</span><span class="font-mono">G</span></div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">ESC ile kapat</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({
            duration: 800,
            once: true,
            offset: 50
        });
        (function(){try{var link=document.querySelector('link[rel=\"canonical\"]'); if(link){ link.href=location.href; }}catch(e){}})

        const rootEl = document.documentElement;
        const storedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (storedTheme === 'dark' || (storedTheme === 'system' && prefersDark) || (!storedTheme && prefersDark)) {
            rootEl.classList.add('dark');
        } else {
            rootEl.classList.remove('dark');
        }
        const themeBtn = document.getElementById('theme-toggle');
        if (themeBtn) {
            themeBtn.addEventListener('click', () => {
                const isDark = rootEl.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }
        const themeBtnMobile = document.getElementById('theme-toggle-mobile');
        if (themeBtnMobile) {
            themeBtnMobile.addEventListener('click', () => {
                const isDark = rootEl.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }
        const navLogin = document.getElementById('nav-login');
        const navRegister = document.getElementById('nav-register');
        const navLogout = document.getElementById('nav-logout');
        const navLoginM = document.getElementById('nav-login-mobile');
        const navRegisterM = document.getElementById('nav-register-mobile');
        const navLogoutM = document.getElementById('nav-logout-mobile');
        function updateAuthLinks() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                if (navLogin) navLogin.classList.add('hidden');
                if (navRegister) navRegister.classList.add('hidden');
                if (navLogout) navLogout.classList.remove('hidden');
                if (navLoginM) navLoginM.classList.add('hidden');
                if (navRegisterM) navRegisterM.classList.add('hidden');
                if (navLogoutM) navLogoutM.classList.remove('hidden');
            } else {
                if (navLogin) navLogin.classList.remove('hidden');
                if (navRegister) navRegister.classList.remove('hidden');
                if (navLogout) navLogout.classList.add('hidden');
                if (navLoginM) navLoginM.classList.remove('hidden');
                if (navRegisterM) navRegisterM.classList.remove('hidden');
                if (navLogoutM) navLogoutM.classList.add('hidden');
            }
        }
        updateAuthLinks();
        if (navLogout) {
            navLogout.addEventListener('click', () => {
                localStorage.removeItem('auth_token');
                updateAuthLinks();
                window.location.href = '{% url "home" %}';
            });
        }
        if (navLogoutM) {
            navLogoutM.addEventListener('click', () => {
                localStorage.removeItem('auth_token');
                updateAuthLinks();
                window.location.href = '{% url "home" %}';
            });
        }

        const mobileBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileBtn && mobileMenu) {
            mobileBtn.addEventListener('click', () => {
                const expanded = mobileBtn.getAttribute('aria-expanded') === 'true';
                mobileBtn.setAttribute('aria-expanded', String(!expanded));
                if (expanded) {
                    mobileMenu.classList.add('hidden');
                } else {
                    mobileMenu.classList.remove('hidden');
                }
            });
            mobileMenu.addEventListener('click', (e) => {
                if (e.target.closest('a') || e.target.closest('button')) {
                    mobileMenu.classList.add('hidden');
                    mobileBtn.setAttribute('aria-expanded', 'false');
                }
            });
        }

        // Chat Widget Logic
        const chatWindow = document.getElementById('chat-window');
        const chatBtn = document.getElementById('chat-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        let isChatOpen = false;

        function toggleChat() {
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                chatWindow.classList.remove('hidden');
                // Trigger reflow
                void chatWindow.offsetWidth;
                chatWindow.classList.remove('scale-95', 'opacity-0');
                chatWindow.classList.add('scale-100', 'opacity-100');
                chatBtn.classList.remove('animate-bounce');
                setTimeout(() => chatInput.focus(), 300);
            } else {
                chatWindow.classList.remove('scale-100', 'opacity-100');
                chatWindow.classList.add('scale-95', 'opacity-0');
                setTimeout(() => chatWindow.classList.add('hidden'), 300);
                chatBtn.classList.add('animate-bounce');
            }
        }

        async function sendMessage(e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (!message) return;
            if (!navigator.onLine) { showToast('Çevrimdışı'); return; }

            // Add User Message
            appendMessage('user', message);
            chatInput.value = '';

            // Show Typing Indicator
            const typingId = showTyping();

            try {
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ message: message, context_tool: getToolContext(), intent: currentPromptIntent })
                });
                
                const data = await response.json();
                
                // Remove Typing Indicator
                removeTyping(typingId);
                
                // Add AI Message
                appendMessage('ai', data.response);
            } catch (error) {
                removeTyping(typingId);
                appendMessage('ai', "Üzgünüm, şu anda bağlantı kuramıyorum. Lütfen daha sonra tekrar dene.");
                console.error('Chat Error:', error);
            }
        }

        function appendMessage(sender, text) {
            const div = document.createElement('div');
            div.className = sender === 'user' ? 'flex items-end justify-end gap-2' : 'flex items-start gap-2';
            
            if (sender === 'ai') {
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs flex-shrink-0">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-sm text-gray-700 max-w-[80%]">
                        ${text}
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="bg-blue-600 p-3 rounded-2xl rounded-tr-none shadow-md text-sm text-white max-w-[80%]">
                        ${text}
                    </div>
                `;
            }
            
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTyping() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex items-start gap-2';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs flex-shrink-0">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-sm text-gray-500 flex gap-1 items-center h-10">
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span>
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                </div>
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // Helper to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        let currentPromptIntent = '';
        function getToolContext() {
            const el = document.getElementById('tool-name-display');
            return el ? el.textContent.trim() : '';
        }
        function setPrompts() {
            const wrap = document.getElementById('chat-prompts');
            if (!wrap) return;
            const tool = getToolContext();
            const base = [
                { t: 'Nasıl çalışır?', i: 'explain' },
                { t: 'Örnek göster', i: 'example' },
                { t: 'Hata kontrolü', i: 'validate' }
            ];
            let extra = [];
            if (tool.includes('Molekül')) {
                extra = [
                    { t: 'Formül yazımı ipuçları', i: 'tips_formula' },
                    { t: 'Element sembolleri', i: 'symbols' }
                ];
            } else if (tool.includes('pH')) {
                extra = [
                    { t: 'pH/pOH ilişkisi', i: 'ph_poh' },
                    { t: 'Örnek çözüm', i: 'example_ph' }
                ];
            }
            const prompts = [...base, ...extra];
            wrap.innerHTML = '';
            prompts.forEach(p => {
                const b = document.createElement('button');
                b.type = 'button';
                b.className = 'px-3 py-1.5 rounded-full text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 transition';
                b.textContent = p.t;
                b.addEventListener('click', () => {
                    currentPromptIntent = p.i;
                    chatInput.value = p.t;
                    chatInput.focus();
                });
                wrap.appendChild(b);
            });
        }
        setPrompts();
        function showToast(msg) {
            const t = document.getElementById('toast');
            if (!t) return;
            t.textContent = msg || '';
            t.classList.remove('hidden');
            t.style.opacity = '1';
            setTimeout(() => { t.style.opacity = '0'; }, 1600);
            setTimeout(() => { t.classList.add('hidden'); }, 2000);
        }
        window.showToast = showToast;
        function setLoading(show) {
            const ov = document.getElementById('loading-overlay');
            if (!ov) return;
            if (show) { ov.classList.remove('hidden'); } else { ov.classList.add('hidden'); }
        }
        function reduceMotionEnabled() {
            const stored = localStorage.getItem('reduce_motion');
            const prefers = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            return stored === 'true' || prefers;
        }
        function toggleReduceMotion() {
            const current = localStorage.getItem('reduce_motion') === 'true';
            const next = !current;
            localStorage.setItem('reduce_motion', next.toString());
            if (window.setParticlesEnabled) window.setParticlesEnabled(!next);
            showToast(next ? 'Animasyonlar azaltıldı' : 'Animasyonlar etkin');
        }
        const backTopBtn = document.getElementById('back-to-top-btn');
        if (backTopBtn) {
            window.addEventListener('scroll', () => {
                const y = window.scrollY || document.documentElement.scrollTop;
                const show = y > 400;
                backTopBtn.style.opacity = show ? '1' : '0';
                backTopBtn.style.pointerEvents = show ? 'auto' : 'none';
            }, { passive: true });
            backTopBtn.addEventListener('click', () => {
                const behavior = reduceMotionEnabled() ? 'auto' : 'smooth';
                window.scrollTo({ top: 0, behavior });
            });
        }
        const offlineBanner = document.getElementById('offline-banner');
        const offlineDismiss = document.getElementById('offline-dismiss');
        const offlineReload = document.getElementById('offline-reload');
        const onlineIndicator = document.getElementById('online-indicator');
        function setOfflineUI() {
            if (!offlineBanner) return;
            if (!navigator.onLine) {
                offlineBanner.classList.remove('hidden');
            } else {
                offlineBanner.classList.add('hidden');
            }
            if (onlineIndicator) {
                onlineIndicator.classList.toggle('bg-green-500', navigator.onLine);
                onlineIndicator.classList.toggle('bg-red-500', !navigator.onLine);
            }
        }
        window.addEventListener('online', () => { setOfflineUI(); showToast('Çevrimiçi'); });
        window.addEventListener('offline', () => { setOfflineUI(); showToast('Çevrimdışı'); });
        if (offlineDismiss) { offlineDismiss.addEventListener('click', () => offlineBanner.classList.add('hidden')); }
        if (offlineReload) { offlineReload.addEventListener('click', () => location.reload()); }
        setOfflineUI();
        const shortcutsModal = document.getElementById('shortcuts-modal');
        const shortcutsClose = document.getElementById('shortcuts-close');
        function openShortcuts() {
            shortcutsModal.classList.remove('hidden');
        }
        function closeShortcuts() {
            shortcutsModal.classList.add('hidden');
        }
        if (shortcutsClose) {
            shortcutsClose.addEventListener('click', closeShortcuts);
        }
        if (shortcutsModal) {
            shortcutsModal.addEventListener('click', (e) => {
                if (e.target === shortcutsModal.querySelector('.absolute.inset-0.bg-black\\/50')) {
                    closeShortcuts();
                }
            });
        }
        document.addEventListener('keydown', (e) => {
            const tag = e.target.tagName.toLowerCase();
            if (tag === 'input' || tag === 'textarea') return;
            if (e.key === 't') {
                const isDark = rootEl.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                showToast(isDark ? 'Koyu tema' : 'Açık tema');
            } else if (e.key === 'c') {
                toggleChat();
            } else if (e.key === '?') {
                openShortcuts();
            } else if (e.key.toLowerCase() === 'r') {
                toggleReduceMotion();
            } else if (e.key.toLowerCase() === 'g') {
                const behavior = reduceMotionEnabled() ? 'auto' : 'smooth';
                window.scrollTo({ top: 0, behavior });
            } else if ((e.altKey && (e.key === '=' || e.key === '+')) || (e.altKey && e.key === '-')) {
                e.preventDefault();
                const cur = parseFloat(getComputedStyle(document.documentElement).fontSize) || 16;
                const next = e.key === '-' ? Math.max(12, cur - 1) : Math.min(22, cur + 1);
                document.documentElement.style.fontSize = next + 'px';
                localStorage.setItem('font_size', String(next));
                showToast('Yazı boyutu: ' + next);
            } else if (e.key === 'Escape') {
                closeShortcuts();
            }
        });
        (function(){
            const fs = parseFloat(localStorage.getItem('font_size')||'0');
            if (fs) document.documentElement.style.fontSize = fs + 'px';
        })();
        document.addEventListener('keydown', (e) => {
            const el = e.target;
            if (el && el.tagName && el.tagName.toLowerCase() === 'input' && el.type === 'number') {
                if (e.ctrlKey && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                    e.preventDefault();
                    const step = parseFloat(el.step || '1');
                    const cur = parseFloat(el.value || '0') || 0;
                    el.value = (e.key === 'ArrowUp' ? cur + step : cur - step).toString();
                    el.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        });
        window.addEventListener('error', (e) => {
            showToast('Beklenmeyen hata');
        });
        window.addEventListener('unhandledrejection', () => {
            showToast('Beklenmeyen hata');
        });
        let deferredPrompt = null;
        const installBtn = document.getElementById('install-btn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installBtn) installBtn.style.display = 'inline-flex';
        });
        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                installBtn.style.display = 'none';
            });
        }
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js').then(() => {
                console.log('sw');
            }).catch(() => {});
        }
        const sharePageBtn = document.getElementById('share-page-btn');
        if (sharePageBtn) {
            sharePageBtn.addEventListener('click', async () => {
                try {
                    if (navigator.share) {
                        await navigator.share({ title: document.title, text: document.title, url: location.href });
                    } else {
                        await navigator.clipboard?.writeText(location.href);
                        showToast('Bağlantı kopyalandı');
                    }
                } catch {}
            });
        }
        const shortcutsBtn = document.getElementById('shortcuts-btn');
        if (shortcutsBtn) { shortcutsBtn.addEventListener('click', () => openShortcuts()); }
        const reduceMotionBtn = document.getElementById('reduce-motion-btn');
        if (reduceMotionBtn) { reduceMotionBtn.addEventListener('click', () => toggleReduceMotion()); }
        const themeSystemBtn = document.getElementById('theme-system-btn');
        if (themeSystemBtn) {
            themeSystemBtn.addEventListener('click', () => {
                localStorage.setItem('theme', 'system');
                const prefersDarkNow = window.matchMedia('(prefers-color-scheme: dark)').matches;
                rootEl.classList.toggle('dark', prefersDarkNow);
                showToast('Sistem teması');
            });
        }
        const fontResetBtn = document.getElementById('font-reset-btn');
        if (fontResetBtn) {
            fontResetBtn.addEventListener('click', () => {
                document.documentElement.style.fontSize = '';
                localStorage.removeItem('font_size');
                showToast('Yazı boyutu sıfırlandı');
            });
        }
        const swUpdateBtn = document.getElementById('sw-update-btn');
        if (swUpdateBtn) {
            swUpdateBtn.addEventListener('click', async () => {
                try {
                    const regs = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(regs.map(r => r.update()));
                    showToast('Güncellemeler kontrol edildi');
                } catch {}
            });
        }
        const cmdOpenBtn = document.getElementById('cmd-open-btn');
        if (cmdOpenBtn) { cmdOpenBtn.addEventListener('click', () => openCmd()); }
        if (chatInput) {
            chatInput.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    const form = chatInput.closest('form');
                    if (form) form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                }
            });
        }
        const navbarEl = document.getElementById('navbar');
        let lastY = 0;
        window.addEventListener('scroll', () => {
            const y = window.scrollY || document.documentElement.scrollTop;
            if (y > 80 && y > lastY) {
                navbarEl.style.transform = 'translateY(-100%)';
            } else {
                navbarEl.style.transform = 'translateY(0)';
            }
            lastY = y;
        }, { passive: true });
        let cmdLoaded = false;
        function openCmd() {
            const m = document.getElementById('cmd-modal'); if (!m) return; m.classList.remove('hidden');
            const inp = document.getElementById('cmd-input'); if (inp) { inp.value=''; inp.focus(); }
            const list = document.getElementById('cmd-list'); if (list) list.innerHTML='';
            if (!cmdLoaded) {
                setLoading(true);
                fetch('{% url "calculator_list" %}').then(r=>r.text()).then(html=>{
                    cmdLoaded = true;
                    const div = document.createElement('div'); div.innerHTML = html;
                    const items = Array.from(div.querySelectorAll('a[href*="/calculators/"]')).map(a=>({href:a.getAttribute('href'), text:(a.querySelector('h3')?.textContent||a.textContent||'').trim()}));
                    list.dataset.items = JSON.stringify(items);
                    setLoading(false);
                }).catch(()=>{ setLoading(false); });
            }
        }
        function closeCmd(){ const m=document.getElementById('cmd-modal'); if(m) m.classList.add('hidden'); }
        const cmdClose=document.getElementById('cmd-close'); if(cmdClose){ cmdClose.addEventListener('click', closeCmd); }
        const cmdInput=document.getElementById('cmd-input');
        const cmdList=document.getElementById('cmd-list');
        function renderCmd(term) {
            if (!cmdList) return;
            const raw = cmdList.dataset.items || '[]';
            let items = []; try{ items = JSON.parse(raw); }catch{}
            const q = (term||'').toLowerCase();
            const filtered = items.filter(x=>x.text.toLowerCase().includes(q) || x.href.toLowerCase().includes(q)).slice(0, 20);
            cmdList.innerHTML = '';
            filtered.forEach(x=>{
                const a = document.createElement('a');
                a.href = x.href;
                a.className = 'block px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600';
                a.textContent = x.text || x.href;
                a.addEventListener('click', (e)=>{ e.preventDefault(); window.location.href = x.href; });
                cmdList.appendChild(a);
            });
        }
        if (cmdInput) { cmdInput.addEventListener('input', (e)=>{ renderCmd(e.target.value); }); }
        document.addEventListener('keydown', (e)=>{ if (e.ctrlKey && e.key.toLowerCase()==='k'){ e.preventDefault(); openCmd(); } });
        const copyUrlBtn = document.getElementById('copy-url-btn');
        if (copyUrlBtn) { copyUrlBtn.addEventListener('click', ()=>{ navigator.clipboard?.writeText(location.href); showToast('Bağlantı kopyalandı'); }); }
        const clearCacheBtn = document.getElementById('clear-cache-btn');
        if (clearCacheBtn) {
            clearCacheBtn.addEventListener('click', async ()=>{
                try {
                    const regs = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(regs.map(r=>r.unregister()));
                    const names = await caches.keys();
                    await Promise.all(names.map(n=>caches.delete(n)));
                    showToast('Önbellek temizlendi');
                } catch {}
            });
        }
        (function(){
            try{
                const data = {
                    "@context":"https://schema.org",
                    "@type":"WebSite",
                    "name":"ChemPlus",
                    "url":location.origin,
                    "inLanguage":"tr",
                    "potentialAction":{
                        "@type":"SearchAction",
                        "target":location.origin + "/calculators/?q={query}",
                        "query-input":"required name=query"
                    }
                };
                const s=document.createElement('script'); s.type='application/ld+json'; s.text=JSON.stringify(data); document.head.appendChild(s);
            }catch(e){}
        })();
    </script>
    <style>
    .motion-lines {
        position: fixed;
        inset: 0;
        z-index: 0;
        opacity: .08;
        pointer-events: none;
        background-image:
            repeating-linear-gradient(90deg, rgba(59,130,246,.4) 0, rgba(59,130,246,.4) 2px, transparent 2px, transparent 40px),
            repeating-linear-gradient(0deg, rgba(6,182,212,.3) 0, rgba(6,182,212,.3) 2px, transparent 2px, transparent 48px);
        background-size: 200% 200%;
        animation: moveLines 16s linear infinite;
    }
    .dark .motion-lines {
        opacity: .06;
        background-image:
            repeating-linear-gradient(90deg, rgba(59,130,246,.35) 0, rgba(59,130,246,.35) 2px, transparent 2px, transparent 40px),
            repeating-linear-gradient(0deg, rgba(14,165,233,.25) 0, rgba(14,165,233,.25) 2px, transparent 2px, transparent 48px);
    }
    @keyframes moveLines {
        0% { background-position: 0% 0%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 100%; }
    }
    </style>
    <style>
    #molecule-canvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: .8; }
    </style>
    <canvas id="molecule-canvas"></canvas>
    <script>
        (function(){
            const canvas = document.getElementById('molecule-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            let width = 0, height = 0, running = true;
            function isDark(){ return document.documentElement.classList.contains('dark'); }
            function colors(){
                return isDark()
                    ? { dot: 'rgba(147,197,253,0.9)', line: 'rgba(147,197,253,0.35)', bg: 'transparent' }
                    : { dot: 'rgba(37,99,235,0.9)', line: 'rgba(14,165,233,0.35)', bg: 'transparent' };
            }
            function resize(){
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
                const count = Math.max(40, Math.floor(Math.min(width, height) / 12));
                particles = Array.from({length: count}).map(()=>({
                    x: Math.random()*width,
                    y: Math.random()*height,
                    r: Math.random()*2 + 1.2,
                    vx: (Math.random()-0.5) * 0.6,
                    vy: (Math.random()-0.5) * 0.6
                }));
            }
            function step(){
                if (!running) return;
                const col = colors();
                ctx.clearRect(0,0,width,height);
                for (let i=0;i<particles.length;i++){
                    const p = particles[i];
                    p.x += p.vx; p.y += p.vy;
                    if (p.x < 0 || p.x > width) p.vx *= -1;
                    if (p.y < 0 || p.y > height) p.vy *= -1;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                    ctx.fillStyle = col.dot;
                    ctx.shadowColor = col.dot;
                    ctx.shadowBlur = 8;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
                for (let i=0;i<particles.length;i++){
                    for (let j=i+1;j<particles.length;j++){
                        const a = particles[i], b = particles[j];
                        const dx = a.x - b.x, dy = a.y - b.y;
                        const d = Math.sqrt(dx*dx + dy*dy);
                        if (d < 90){
                            ctx.strokeStyle = col.line;
                            ctx.lineWidth = 1;
                            ctx.beginPath();
                            ctx.moveTo(a.x, a.y);
                            ctx.lineTo(b.x, b.y);
                            ctx.stroke();
                        }
                    }
                }
                requestAnimationFrame(step);
            }
            window.addEventListener('resize', resize);
            document.addEventListener('visibilitychange', ()=>{ running = !document.hidden; if (running) step(); });
            resize(); step();
            window.updateParticleColors = ()=>{}; 
            window.setParticlesEnabled = (enabled) => { running = enabled; canvas.style.display = enabled ? '' : 'none'; if (enabled) step(); };
            if (window.reduceMotionEnabled && window.reduceMotionEnabled()) { window.setParticlesEnabled(false); }
        })();
    </script>
</body>
</html>
